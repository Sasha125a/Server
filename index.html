<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–µ—Ä–µ—Å—Ç–∞ - –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .messenger-container {
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            display: flex;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        /* –°–∞–π–¥–±–∞—Ä */
        .sidebar {
            width: 350px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            flex-shrink: 0;
        }

        .user-details {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 600;
            font-size: 18px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-status {
            font-size: 14px;
            color: #28a745;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }

        .status-dot.offline {
            background: #6c757d;
        }

        .sidebar-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-btn {
            padding: 12px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .new-chat-btn {
            background: #667eea;
            color: white;
        }

        .new-chat-btn:hover {
            background: #5a67d8;
        }

        .add-friend-btn {
            background: #28a745;
            color: white;
        }

        .add-friend-btn:hover {
            background: #218838;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-item {
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .chat-item.active {
            background: #e6f7ff;
            border-color: #1890ff;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        .chat-details {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 600;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .last-message {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            font-size: 12px;
            color: #999;
            margin-left: auto;
            flex-shrink: 0;
        }

        .unread-badge {
            background: #1890ff;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: 5px;
        }

        /* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            display: none;
        }

        .chat-area.active {
            display: flex;
        }

        .chat-header {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-partner-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-actions {
            display: flex;
            gap: 10px;
        }

        .chat-action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .call-btn {
            background: #28a745;
            color: white;
        }

        .call-btn:hover {
            background: #218838;
        }

        .video-btn {
            background: #dc3545;
            color: white;
        }

        .video-btn:hover {
            background: #c82333;
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 70%;
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            display: flex;
            flex-direction: column;
        }

        .message-outgoing {
            background: #667eea;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message-incoming {
            background: white;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message-sender {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .message-text {
            line-height: 1.4;
        }

        .message-time {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
            text-align: right;
        }

        .message-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .message-input:focus {
            border-color: #667eea;
        }

        .send-btn {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .send-btn:hover {
            background: #5a67d8;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .modal-input:focus {
            border-color: #667eea;
            outline: none;
        }

        .modal-input.error {
            border-color: #dc3545;
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: -10px;
            margin-bottom: 15px;
            display: none;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .modal-btn.cancel {
            background: #6c757d;
            color: white;
        }

        .modal-btn.cancel:hover {
            background: #5a6268;
        }

        .modal-btn.create {
            background: #667eea;
            color: white;
        }

        .modal-btn.create:hover {
            background: #5a67d8;
        }

        /* –°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π */
        .friends-section {
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin: 10px;
            flex: 1;
            overflow-y: auto;
        }

        .friends-section h4 {
            margin-bottom: 15px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .friend-item {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .friend-item:hover {
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .friend-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        .friend-details {
            flex: 1;
            min-width: 0;
        }

        .friend-name {
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .friend-email {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .friend-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #6c757d;
            flex-shrink: 0;
        }

        .friend-status.online {
            background: #28a745;
        }

        .friend-status.offline {
            background: #6c757d;
        }

        /* –ó–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–∑—å—è */
        .friend-request-item {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .request-details {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .request-actions {
            display: flex;
            gap: 5px;
        }

        .request-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s;
        }

        .accept-btn {
            background: #28a745;
            color: white;
        }

        .accept-btn:hover {
            background: #218838;
        }

        .reject-btn {
            background: #dc3545;
            color: white;
        }

        .reject-btn:hover {
            background: #c82333;
        }

        /* –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
        .search-results {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* –û–±–ª–∞—Å—Ç—å –∑–≤–æ–Ω–∫–∞ */
        .call-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .call-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .call-avatar {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 36px;
            margin: 0 auto 20px;
        }

        .call-partner {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .call-status {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
        }

        .call-timer {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            color: #333;
        }

        .call-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }

        .call-control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s;
        }

        .call-control-btn.accept {
            background: #28a745;
            color: white;
        }

        .call-control-btn.accept:hover {
            background: #218838;
        }

        .call-control-btn.reject {
            background: #dc3545;
            color: white;
        }

        .call-control-btn.reject:hover {
            background: #c82333;
        }

        .call-control-btn.end-call {
            background: #dc3545;
            color: white;
        }

        .call-control-btn.end-call:hover {
            background: #c82333;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .messenger-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .chat-area {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: white;
                z-index: 100;
            }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* –£—Ç–∏–ª–∏—Ç—ã */
        .hidden {
            display: none !important;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* –°–ø–∏—Å–∫–∏ —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π */
        .scrollable {
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }

        .scrollable::-webkit-scrollbar {
            width: 6px;
        }

        .scrollable::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .scrollable::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .scrollable::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <!-- –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="messenger-container" id="messengerContainer">
        <!-- –°–∞–π–¥–±–∞—Ä -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-info" id="userInfo">
                    <div class="user-avatar" id="userAvatar">–ë</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">–ì–æ—Å—Ç—å</div>
                        <div class="user-status" id="userStatus">
                            <span class="status-dot offline"></span>
                            <span id="statusText">–Ω–µ –≤ —Å–µ—Ç–∏</span>
                        </div>
                    </div>
                </div>
                <div class="sidebar-actions">
                    <button class="action-btn new-chat-btn" id="newChatBtn">
                        <span>üí¨</span> –ù–æ–≤—ã–π —á–∞—Ç
                    </button>
                    <button class="action-btn add-friend-btn" id="addFriendBtn">
                        <span>üë•</span> –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞
                    </button>
                    <button class="action-btn logout-btn" id="logoutBtn" style="display: none;">
                        <span>üö™</span> –í—ã–π—Ç–∏
                    </button>
                </div>
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
            <div class="chat-list scrollable" id="chatList">
                <div class="empty-state" id="emptyChats">
                    <div class="empty-state-icon">üí¨</div>
                    <h4>–ù–µ—Ç —á–∞—Ç–æ–≤</h4>
                    <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ, —Å–æ–∑–¥–∞–≤ –Ω–æ–≤—ã–π —á–∞—Ç</p>
                </div>
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π -->
            <div class="friends-section scrollable" id="friendsSection" style="display: none;">
                <h4>–î—Ä—É–∑—å—è <span id="friendsCount">(0)</span></h4>
                <div id="friendsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <h4>–ù–µ—Ç –¥—Ä—É–∑–µ–π</h4>
                        <p>–î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–∑–µ–π –ø–æ email</p>
                    </div>
                </div>
                
                <!-- –ó–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–∑—å—è -->
                <div id="friendRequestsSection" style="display: none; margin-top: 20px;">
                    <h4>–ó–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–∑—å—è</h4>
                    <div id="friendRequestsList"></div>
                </div>
            </div>
        </div>

        <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
        <div class="chat-area" id="chatArea">
            <div class="chat-header">
                <div class="chat-partner-info" id="chatPartnerInfo">
                    <div class="user-avatar" id="chatPartnerAvatar">–î</div>
                    <div>
                        <div class="user-name" id="chatPartnerName">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
                        <div class="user-status" id="chatPartnerStatus">...</div>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="chat-action-btn call-btn" id="voiceCallBtn" disabled>
                        <span>üìû</span> –ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫
                    </button>
                    <button class="chat-action-btn video-btn" id="videoCallBtn" disabled>
                        <span>üé•</span> –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫
                    </button>
                </div>
            </div>

            <div class="messages-container scrollable" id="messagesContainer">
                <div class="empty-state" id="emptyMessages">
                    <div class="empty-state-icon">üí≠</div>
                    <h4>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</h4>
                    <p>–ù–∞—á–Ω–∏—Ç–µ –±–µ—Å–µ–¥—É, –æ—Ç–ø—Ä–∞–≤–∏–≤ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</p>
                </div>
            </div>

            <div class="message-input-area" id="messageInputArea" style="display: none;">
                <input type="text" 
                       class="message-input" 
                       id="messageInput" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                       autocomplete="off"
                       disabled>
                <button class="send-btn" id="sendBtn" disabled>
                    <span>‚úàÔ∏è</span> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <h3>üå≥ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ë–µ—Ä–µ—Å—Ç–∞</h3>
            
            <div class="tabs">
                <button class="tab-btn active" id="loginTabBtn">–í—Ö–æ–¥</button>
                <button class="tab-btn" id="registerTabBtn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
            
            <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
            <div id="loginForm">
                <input type="email" 
                       class="modal-input" 
                       id="loginEmail" 
                       placeholder="Email"
                       required>
                <div class="error-message" id="loginEmailError"></div>
                
                <input type="password" 
                       class="modal-input" 
                       id="loginPassword" 
                       placeholder="–ü–∞—Ä–æ–ª—å"
                       required>
                <div class="error-message" id="loginPasswordError"></div>
                
                <div style="color: #666; font-size: 14px; margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                    <strong>–î–µ–º–æ –∞–∫–∫–∞—É–Ω—Ç—ã:</strong><br>
                    ‚Ä¢ anna@example.com / test123<br>
                    ‚Ä¢ ivan@example.com / test123<br>
                    ‚Ä¢ maria@example.com / test123
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
            <div id="registerForm" style="display: none;">
                <input type="text" 
                       class="modal-input" 
                       id="registerName" 
                       placeholder="–ò–º—è"
                       required>
                <div class="error-message" id="registerNameError"></div>
                
                <input type="email" 
                       class="modal-input" 
                       id="registerEmail" 
                       placeholder="Email"
                       required>
                <div class="error-message" id="registerEmailError"></div>
                
                <input type="password" 
                       class="modal-input" 
                       id="registerPassword" 
                       placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)"
                       required>
                <div class="error-message" id="registerPasswordError"></div>
                
                <input type="password" 
                       class="modal-input" 
                       id="registerConfirmPassword" 
                       placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                       required>
                <div class="error-message" id="registerConfirmPasswordError"></div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="authCancelBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="modal-btn create" id="authSubmitBtn">
                    <span id="authSubmitText">–í–æ–π—Ç–∏</span>
                    <span class="loading" id="authLoading" style="display: none;"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ -->
    <div class="modal" id="newChatModal">
        <div class="modal-content">
            <h3>üí¨ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç</h3>
            
            <div style="margin-bottom: 20px;">
                <div class="tabs">
                    <button class="tab-btn active" id="newChatWithFriendTab">–° –¥—Ä—É–≥–æ–º</button>
                    <button class="tab-btn" id="newChatByEmailTab">–ü–æ email</button>
                </div>
            </div>
            
            <!-- –° –¥—Ä—É–∑—å—è–º–∏ -->
            <div id="newChatWithFriend">
                <div class="friends-section scrollable" style="max-height: 300px;">
                    <h4>–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞</h4>
                    <div id="friendsForChatList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üë•</div>
                            <p>–ù–µ—Ç –¥—Ä—É–∑–µ–π –¥–ª—è —á–∞—Ç–∞</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –ü–æ email -->
            <div id="newChatByEmail" style="display: none;">
                <input type="email" 
                       class="modal-input" 
                       id="newChatEmail" 
                       placeholder="Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
                       required>
                <div class="error-message" id="newChatEmailError"></div>
                
                <div id="userSearchResults" class="search-results"></div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="cancelNewChat">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn create" id="createNewChat" disabled>
                    <span id="createChatText">–°–æ–∑–¥–∞—Ç—å</span>
                    <span class="loading" id="createChatLoading" style="display: none;"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥—Ä—É–≥–∞ -->
    <div class="modal" id="addFriendModal">
        <div class="modal-content">
            <h3>üë• –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</h3>
            
            <input type="email" 
                   class="modal-input" 
                   id="friendEmail" 
                   placeholder="Email –¥—Ä—É–≥–∞"
                   required>
            <div class="error-message" id="friendEmailError"></div>
            
            <div id="friendSearchResults" class="search-results"></div>
            
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="cancelAddFriend">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn create" id="sendFriendRequestBtn" disabled>
                    <span id="sendRequestText">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</span>
                    <span class="loading" id="sendRequestLoading" style="display: none;"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- –û–∫–Ω–æ –∑–≤–æ–Ω–∫–∞ -->
    <div class="call-container" id="callContainer">
        <div class="call-box">
            <div class="call-avatar" id="callAvatar">–î</div>
            <div class="call-partner" id="callPartnerName">–î—Ä—É–∑—å—è</div>
            <div class="call-status" id="callStatus">–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...</div>
            <div class="call-timer" id="callTimer">00:00</div>
            <div class="call-controls">
                <button class="call-control-btn accept" id="acceptCallBtn">‚úì</button>
                <button class="call-control-btn reject" id="rejectCallBtn">‚úó</button>
                <button class="call-control-btn end-call" id="endCallBtn" style="display: none;">‚úó</button>
            </div>
        </div>
    </div>

    <!-- –°–∫—Ä–∏–ø—Ç—ã -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        class BerezaMessenger {
            constructor() {
                this.socket = null;
                this.currentUser = null;
                this.authToken = null;
                this.chats = [];
                this.friends = [];
                this.friendRequests = [];
                this.currentChatId = null;
                this.currentCall = null;
                this.callTimerInterval = null;
                this.callStartTime = null;
                this.isAuthenticated = false;
                
                this.init();
            }

            async init() {
                this.checkAuth();
                this.setupEventListeners();
                
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
                if (this.isAuthenticated) {
                    await this.connectToServer();
                }
            }

            checkAuth() {
                this.authToken = localStorage.getItem('beresta_token');
                const userData = localStorage.getItem('beresta_user');
                
                if (this.authToken && userData) {
                    try {
                        this.currentUser = JSON.parse(userData);
                        this.isAuthenticated = true;
                        this.updateUserUI();
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                        this.clearAuth();
                    }
                }
                
                if (!this.isAuthenticated) {
                    this.showAuthModal();
                }
            }

            updateUserUI() {
                if (this.currentUser) {
                    document.getElementById('userName').textContent = this.currentUser.name;
                    document.getElementById('userAvatar').textContent = this.currentUser.avatar;
                    document.getElementById('userStatus').querySelector('#statusText').textContent = '–≤ —Å–µ—Ç–∏';
                    document.getElementById('userStatus').querySelector('.status-dot').classList.remove('offline');
                    document.getElementById('logoutBtn').style.display = 'flex';
                    document.getElementById('friendsSection').style.display = 'block';
                } else {
                    document.getElementById('userName').textContent = '–ì–æ—Å—Ç—å';
                    document.getElementById('userAvatar').textContent = '–ë';
                    document.getElementById('userStatus').querySelector('#statusText').textContent = '–Ω–µ –≤ —Å–µ—Ç–∏';
                    document.getElementById('userStatus').querySelector('.status-dot').classList.add('offline');
                    document.getElementById('logoutBtn').style.display = 'none';
                    document.getElementById('friendsSection').style.display = 'none';
                }
            }

            async connectToServer() {
                if (!this.authToken) return;
                
                this.socket = io('https://server-jbw1.onrender.com');
                
                this.socket.on('connect', () => {
                    console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
                    this.socket.emit('authenticate', this.authToken);
                });
                
                this.socket.on('authenticated', (data) => {
                    console.log('–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
                    this.loadInitialData();
                });
                
                this.socket.on('auth_error', (data) => {
                    console.error('–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:', data.error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
                    this.clearAuth();
                });
                
                this.socket.on('chats_list', (chats) => {
                    this.chats = chats;
                    this.renderChatList();
                });
                
                this.socket.on('chat_created', (chat) => {
                    this.chats.push(chat);
                    this.renderChatList();
                    this.showNotification(`–°–æ–∑–¥–∞–Ω —á–∞—Ç: ${chat.name}`, 'success');
                });
                
                this.socket.on('new_message', (data) => {
                    if (data.chatId === this.currentChatId) {
                        this.addMessageToChat(data.message, false);
                    } else {
                        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
                        const chat = this.chats.find(c => c.id === data.chatId);
                        if (chat) {
                            this.showNotification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ ${chat.name}: ${data.message.text.substring(0, 50)}...`, 'info');
                            // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                            this.renderChatList();
                        }
                    }
                });
                
                this.socket.on('friends_list', (friends) => {
                    this.friends = friends;
                    this.renderFriendsList();
                });
                
                this.socket.on('friend_requests', (requests) => {
                    this.friendRequests = requests;
                    this.renderFriendRequests();
                });
                
                this.socket.on('friend_request', (data) => {
                    this.showNotification(`–ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è –æ—Ç ${data.fromUser.name}`, 'info');
                    this.loadFriendRequests();
                });
                
                this.socket.on('friend_request_accepted', (data) => {
                    this.showNotification(`${data.byUser.name} –ø—Ä–∏–Ω—è–ª(–∞) –≤–∞—à –∑–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è`, 'success');
                    this.loadFriends();
                    this.loadFriendRequests();
                });
                
                this.socket.on('friend_status_changed', (data) => {
                    this.updateFriendStatus(data.friendId, data.status, data.lastSeen);
                });
                
                this.socket.on('incoming_call', (data) => {
                    this.showIncomingCall(data);
                });
                
                this.socket.on('call_started', (data) => {
                    this.currentCall = data.callData;
                    this.showCallInterface('calling');
                });
                
                this.socket.on('call_accepted', (data) => {
                    if (this.currentCall && this.currentCall.id === data.callId) {
                        this.currentCall = data.callData;
                        this.startCallTimer();
                        document.getElementById('callStatus').textContent = '–ó–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω';
                    }
                });
                
                this.socket.on('call_ended', (data) => {
                    this.endCall();
                    if (data.duration) {
                        this.showNotification(`–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${this.formatDuration(data.duration)}`, 'info');
                    }
                });
                
                this.socket.on('disconnect', () => {
                    console.log('–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                    this.showNotification('–ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'warning');
                });
            }

            setupEventListeners() {
                // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
                document.getElementById('loginTabBtn').addEventListener('click', () => this.switchAuthTab('login'));
                document.getElementById('registerTabBtn').addEventListener('click', () => this.switchAuthTab('register'));
                document.getElementById('authSubmitBtn').addEventListener('click', () => this.handleAuthSubmit());
                document.getElementById('authCancelBtn').addEventListener('click', () => this.hideAuthModal());
                
                // –ß–∞—Ç
                document.getElementById('newChatBtn').addEventListener('click', () => this.showNewChatModal());
                document.getElementById('newChatWithFriendTab').addEventListener('click', () => this.switchNewChatTab('friends'));
                document.getElementById('newChatByEmailTab').addEventListener('click', () => this.switchNewChatTab('email'));
                document.getElementById('cancelNewChat').addEventListener('click', () => this.hideNewChatModal());
                document.getElementById('createNewChat').addEventListener('click', () => this.createNewChat());
                document.getElementById('newChatEmail').addEventListener('input', (e) => this.searchUsersForChat(e.target.value));
                
                // –°–æ–æ–±—â–µ–Ω–∏—è
                document.getElementById('sendBtn').addEventListener('click', () => this.sendMessage());
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // –î—Ä—É–∑—å—è
                document.getElementById('addFriendBtn').addEventListener('click', () => this.showAddFriendModal());
                document.getElementById('cancelAddFriend').addEventListener('click', () => this.hideAddFriendModal());
                document.getElementById('sendFriendRequestBtn').addEventListener('click', () => this.sendFriendRequest());
                document.getElementById('friendEmail').addEventListener('input', (e) => this.searchUsers(e.target.value));
                
                // –ó–≤–æ–Ω–∫–∏
                document.getElementById('voiceCallBtn').addEventListener('click', () => this.startCall('voice'));
                document.getElementById('videoCallBtn').addEventListener('click', () => this.startCall('video'));
                document.getElementById('acceptCallBtn').addEventListener('click', () => this.acceptCall());
                document.getElementById('rejectCallBtn').addEventListener('click', () => this.rejectCall());
                document.getElementById('endCallBtn').addEventListener('click', () => this.endCall());
                
                // –í—ã—Ö–æ–¥
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                
                // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–º–æ –¥–∞–Ω–Ω—ã—Ö
                document.getElementById('loginEmail').addEventListener('focus', () => {
                    if (!document.getElementById('loginEmail').value) {
                        document.getElementById('loginEmail').value = 'anna@example.com';
                        document.getElementById('loginPassword').value = 'test123';
                    }
                });
            }

            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
            switchAuthTab(tab) {
                const isLogin = tab === 'login';
                document.getElementById('loginTabBtn').classList.toggle('active', isLogin);
                document.getElementById('registerTabBtn').classList.toggle('active', !isLogin);
                document.getElementById('loginForm').style.display = isLogin ? 'block' : 'none';
                document.getElementById('registerForm').style.display = isLogin ? 'none' : 'block';
                document.getElementById('authSubmitText').textContent = isLogin ? '–í–æ–π—Ç–∏' : '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
                
                // –û—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–æ–∫
                this.clearAuthErrors();
            }

            clearAuthErrors() {
                document.querySelectorAll('.error-message').forEach(el => {
                    el.style.display = 'none';
                    el.textContent = '';
                });
                document.querySelectorAll('.modal-input').forEach(el => {
                    el.classList.remove('error');
                });
            }

            showAuthModal() {
                document.getElementById('authModal').style.display = 'flex';
                this.switchAuthTab('login');
            }

            hideAuthModal() {
                if (this.isAuthenticated) {
                    document.getElementById('authModal').style.display = 'none';
                }
            }

            async handleAuthSubmit() {
                const isLogin = document.getElementById('loginTabBtn').classList.contains('active');
                
                if (isLogin) {
                    await this.handleLogin();
                } else {
                    await this.handleRegister();
                }
            }

            async handleLogin() {
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value.trim();
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                let hasError = false;
                this.clearAuthErrors();
                
                if (!email) {
                    this.showError('loginEmail', 'Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
                    hasError = true;
                }
                
                if (!password) {
                    this.showError('loginPassword', '–ü–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
                    hasError = true;
                }
                
                if (hasError) return;
                
                // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                this.showLoading('auth', true);
                
                try {
                    const response = await fetch('https://server-jbw1.onrender.com/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        await this.handleAuthSuccess(data);
                    } else {
                        this.showError('loginPassword', data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
                    }
                } catch (error) {
                    this.showError('loginPassword', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                } finally {
                    this.showLoading('auth', false);
                }
            }

            async handleRegister() {
                const name = document.getElementById('registerName').value.trim();
                const email = document.getElementById('registerEmail').value.trim();
                const password = document.getElementById('registerPassword').value.trim();
                const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                let hasError = false;
                this.clearAuthErrors();
                
                if (!name) {
                    this.showError('registerName', '–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
                    hasError = true;
                }
                
                if (!email) {
                    this.showError('registerEmail', 'Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
                    hasError = true;
                } else if (!this.isValidEmail(email)) {
                    this.showError('registerEmail', '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email');
                    hasError = true;
                }
                
                if (!password) {
                    this.showError('registerPassword', '–ü–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
                    hasError = true;
                } else if (password.length < 6) {
                    this.showError('registerPassword', '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤');
                    hasError = true;
                }
                
                if (!confirmPassword) {
                    this.showError('registerConfirmPassword', '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
                    hasError = true;
                } else if (password !== confirmPassword) {
                    this.showError('registerConfirmPassword', '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                    hasError = true;
                }
                
                if (hasError) return;
                
                // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                this.showLoading('auth', true);
                
                try {
                    const response = await fetch('https://server-jbw1.onrender.com/api/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, email, password })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        await this.handleAuthSuccess(data);
                    } else {
                        this.showError('registerEmail', data.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
                    }
                } catch (error) {
                    this.showError('registerEmail', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                } finally {
                    this.showLoading('auth', false);
                }
            }

            async handleAuthSuccess(data) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                localStorage.setItem('beresta_token', data.token);
                localStorage.setItem('beresta_user', JSON.stringify(data.user));
                
                this.authToken = data.token;
                this.currentUser = data.user;
                this.isAuthenticated = true;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                this.updateUserUI();
                
                // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                document.getElementById('authModal').style.display = 'none';
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('registerName').value = '';
                document.getElementById('registerEmail').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('registerConfirmPassword').value = '';
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
                await this.connectToServer();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                this.showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${data.user.name}!`, 'success');
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            async loadInitialData() {
                await Promise.all([
                    this.loadChats(),
                    this.loadFriends(),
                    this.loadFriendRequests()
                ]);
            }

            async loadChats() {
                try {
                    const response = await fetch('https://server-jbw1.onrender.com/api/chats', {
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });
                    
                    if (response.ok) {
                        this.chats = await response.json();
                        this.renderChatList();
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
                }
            }

            async loadFriends() {
                try {
                    const response = await fetch('https://server-jbw1.onrender.com/api/friends', {
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });
                    
                    if (response.ok) {
                        this.friends = await response.json();
                        this.renderFriendsList();
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–∑–µ–π:', error);
                }
            }

            async loadFriendRequests() {
                try {
                    const response = await fetch('https://server-jbw1.onrender.com/api/friends/requests', {
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });
                    
                    if (response.ok) {
                        this.friendRequests = await response.json();
                        this.renderFriendRequests();
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:', error);
                }
            }

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–æ–≤
            renderChatList() {
                const chatList = document.getElementById('chatList');
                const emptyChats = document.getElementById('emptyChats');
                
                if (this.chats.length === 0) {
                    emptyChats.style.display = 'block';
                    chatList.innerHTML = '';
                    return;
                }
                
                emptyChats.style.display = 'none';
                
                chatList.innerHTML = this.chats.map(chat => {
                    const lastMessage = chat.lastMessage;
                    const isActive = chat.id === this.currentChatId;
                    const unreadCount = chat.unreadCount || 0;
                    
                    let timeText = '';
                    if (lastMessage) {
                        const time = new Date(lastMessage.timestamp);
                        const now = new Date();
                        const diff = now - time;
                        
                        if (diff < 86400000) { // –ú–µ–Ω–µ–µ —Å—É—Ç–æ–∫
                            timeText = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        } else if (diff < 604800000) { // –ú–µ–Ω–µ–µ –Ω–µ–¥–µ–ª–∏
                            timeText = time.toLocaleDateString([], { weekday: 'short' });
                        } else {
                            timeText = time.toLocaleDateString([], { month: 'short', day: 'numeric' });
                        }
                    }
                    
                    return `
                        <div class="chat-item ${isActive ? 'active' : ''}" data-chat-id="${chat.id}">
                            <div class="chat-avatar">${chat.name.charAt(0)}</div>
                            <div class="chat-details">
                                <div class="chat-name">${chat.name}</div>
                                <div class="last-message">${lastMessage ? lastMessage.text : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                            </div>
                            <div class="chat-time">${timeText}</div>
                            ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
                        </div>
                    `;
                }).join('');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                chatList.querySelectorAll('.chat-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const chatId = item.getAttribute('data-chat-id');
                        this.selectChat(chatId);
                    });
                });
            }

            renderFriendsList() {
                const friendsList = document.getElementById('friendsList');
                const friendsCount = document.getElementById('friendsCount');
                
                friendsCount.textContent = `(${this.friends.length})`;
                
                if (this.friends.length === 0) {
                    friendsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üë•</div>
                            <p>–ù–µ—Ç –¥—Ä—É–∑–µ–π. –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–∑–µ–π –ø–æ email</p>
                        </div>
                    `;
                    return;
                }
                
                friendsList.innerHTML = this.friends.map(friend => `
                    <div class="friend-item" data-friend-id="${friend.id}">
                        <div class="friend-avatar">${friend.avatar}</div>
                        <div class="friend-details">
                            <div class="friend-name">${friend.name}</div>
                            <div class="friend-email">${friend.email}</div>
                        </div>
                        <div class="friend-status ${friend.isOnline ? 'online' : 'offline'}"></div>
                    </div>
                `).join('');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                friendsList.querySelectorAll('.friend-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const friendId = item.getAttribute('data-friend-id');
                        this.startChatWithFriend(friendId);
                    });
                });
            }

            renderFriendRequests() {
                const requestsList = document.getElementById('friendRequestsList');
                const requestsSection = document.getElementById('friendRequestsSection');
                
                if (this.friendRequests.length === 0) {
                    requestsSection.style.display = 'none';
                    return;
                }
                
                requestsSection.style.display = 'block';
                
                requestsList.innerHTML = this.friendRequests.map(request => `
                    <div class="friend-request-item" data-request-id="${request.id}">
                        <div class="request-details">
                            <div class="friend-avatar">${request.fromUser.avatar}</div>
                            <div>
                                <div class="friend-name">${request.fromUser.name}</div>
                                <div class="friend-email">${request.fromUser.email}</div>
                            </div>
                        </div>
                        <div class="request-actions">
                            <button class="request-btn accept-btn" data-action="accept">‚úì</button>
                            <button class="request-btn reject-btn" data-action="reject">‚úó</button>
                        </div>
                    </div>
                `).join('');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                requestsList.querySelectorAll('.request-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const requestId = btn.closest('.friend-request-item').getAttribute('data-request-id');
                        const action = btn.getAttribute('data-action');
                        await this.handleFriendRequest(requestId, action);
                    });
                });
            }

            // –í—ã–±–æ—Ä —á–∞—Ç–∞
            async selectChat(chatId) {
                this.currentChatId = chatId;
                const chat = this.chats.find(c => c.id === chatId);
                
                if (!chat) return;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                this.renderChatList();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞
                document.getElementById('chatArea').classList.add('active');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
                document.getElementById('chatPartnerName').textContent = chat.name;
                document.getElementById('chatPartnerAvatar').textContent = chat.name.charAt(0);
                document.getElementById('callPartnerName').textContent = chat.name;
                document.getElementById('callAvatar').textContent = chat.name.charAt(0);
                
                // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∑–≤–æ–Ω–∫–æ–≤
                document.getElementById('voiceCallBtn').disabled = false;
                document.getElementById('videoCallBtn').disabled = false;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                document.getElementById('messageInputArea').style.display = 'flex';
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                await this.loadChatMessages(chatId);
                
                // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                document.getElementById('messageInput').focus();
            }

            async loadChatMessages(chatId) {
                try {
                    const response = await fetch(`https://server-jbw1.onrender.com/api/chats/${chatId}/messages`, {
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });
                    
                    if (response.ok) {
                        const messages = await response.json();
                        this.renderMessages(messages);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                }
            }

            renderMessages(messages) {
                const messagesContainer = document.getElementById('messagesContainer');
                const emptyMessages = document.getElementById('emptyMessages');
                
                if (messages.length === 0) {
                    emptyMessages.style.display = 'block';
                    messagesContainer.innerHTML = '';
                    return;
                }
                
                emptyMessages.style.display = 'none';
                
                messagesContainer.innerHTML = messages.map(msg => {
                    const isOutgoing = msg.senderId === this.currentUser.id;
                    const time = new Date(msg.timestamp).toLocaleTimeString([], { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    return `
                        <div class="message ${isOutgoing ? 'message-outgoing' : 'message-incoming'}">
                            ${!isOutgoing ? `<div class="message-sender">${msg.senderName}</div>` : ''}
                            <div class="message-text">${this.escapeHtml(msg.text)}</div>
                            <div class="message-time">${time}</div>
                        </div>
                    `;
                }).join('');
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // –°–æ–æ–±—â–µ–Ω–∏—è
            async sendMessage() {
                const input = document.getElementById('messageInput');
                const text = input.value.trim();
                
                if (!text || !this.currentChatId || !this.socket) return;
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ —Å–æ–∫–µ—Ç
                this.socket.emit('send_message', {
                    chatId: this.currentChatId,
                    text: text
                });
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                input.value = '';
                input.focus();
            }

            addMessageToChat(message, isOutgoing) {
                const messagesContainer = document.getElementById('messagesContainer');
                const emptyMessages = document.getElementById('emptyMessages');
                
                emptyMessages.style.display = 'none';
                
                const time = new Date(message.timestamp).toLocaleTimeString([], { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isOutgoing ? 'message-outgoing' : 'message-incoming'}`;
                messageElement.innerHTML = `
                    ${!isOutgoing ? `<div class="message-sender">${message.senderName}</div>` : ''}
                    <div class="message-text">${this.escapeHtml(message.text)}</div>
                    <div class="message-time">${time}</div>
                `;
                
                messagesContainer.appendChild(messageElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // –ù–æ–≤—ã–π —á–∞—Ç
            showNewChatModal() {
                document.getElementById('newChatModal').style.display = 'flex';
                this.switchNewChatTab('friends');
                this.renderFriendsForChat();
            }

            hideNewChatModal() {
                document.getElementById('newChatModal').style.display = 'none';
                document.getElementById('newChatEmail').value = '';
                document.getElementById('userSearchResults').innerHTML = '';
                document.getElementById('createNewChat').disabled = true;
            }

            switchNewChatTab(tab) {
                const isFriends = tab === 'friends';
                document.getElementById('newChatWithFriendTab').classList.toggle('active', isFriends);
                document.getElementById('newChatByEmailTab').classList.toggle('active', !isFriends);
                document.getElementById('newChatWithFriend').style.display = isFriends ? 'block' : 'none';
                document.getElementById('newChatByEmail').style.display = isFriends ? 'none' : 'block';
            }

            renderFriendsForChat() {
                const friendsForChatList = document.getElementById('friendsForChatList');
                
                if (this.friends.length === 0) {
                    friendsForChatList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üë•</div>
                            <p>–ù–µ—Ç –¥—Ä—É–∑–µ–π –¥–ª—è —á–∞—Ç–∞</p>
                        </div>
                    `;
                    return;
                }
                
                friendsForChatList.innerHTML = this.friends.map(friend => `
                    <div class="friend-item" data-friend-id="${friend.id}">
                        <div class="friend-avatar">${friend.avatar}</div>
                        <div class="friend-details">
                            <div class="friend-name">${friend.name}</div>
                            <div class="friend-email">${friend.email}</div>
                        </div>
                    </div>
                `).join('');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                friendsForChatList.querySelectorAll('.friend-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const friendId = item.getAttribute('data-friend-id');
                        this.createChatWithFriend(friendId);
                    });
                });
            }

            async searchUsersForChat(query) {
                if (!query || query.length < 3) {
                    document.getElementById('userSearchResults').innerHTML = '';
                    document.getElementById('createNewChat').disabled = true;
                    return;
                }
                
                try {
                    const response = await fetch(`https://server-jbw1.onrender.com/api/users/search?query=${encodeURIComponent(query)}`, {
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });
                    
                    if (response.ok) {
                        const users = await response.json();
                        this.displayUserSearchResults(users, 'chat');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                }
            }

            async createNewChat() {
                const isEmailTab = document.getElementById('newChatByEmailTab').classList.contains('active');
                
                if (isEmailTab) {
                    const email = document.getElementById('newChatEmail').value.trim();
                    if (!email) {
                        this.showError('newChatEmail', '–í–≤–µ–¥–∏—Ç–µ email');
                        return;
                    }
                    
                    // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email
                    const user = await this.findUserByEmail(email);
                    if (user) {
                        await this.createChatWithUser(user.id);
                    }
                }
            }

            async createChatWithFriend(friendId) {
                await this.createChatWithUser(friendId);
            }

            async createChatWithUser(userId) {
                this.showLoading('createChat', true);
                
                try {
                    const response = await fetch('https://server-jbw1.onrender.com/api/chats', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.authToken}`
                        },
                        body: JSON.stringify({
                            participantIds: [userId]
                        })
                    });
                    
                    if (response.ok) {
                        const chat = await response.json();
                        this.hideNewChatModal();
                        this.selectChat(chat.id);
                        this.showNotification(`–ß–∞—Ç —Å —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ`, 'success');
                    } else {
                        const error = await response.json();
                        this.showNotification(error.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞', 'error');
                    }
                } catch (error) {
                    this.showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                } finally {
                    this.showLoading('createChat', false);
                }
            }

            async startChatWithFriend(friendId) {
                // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç
                const existingChat = this.chats.find(chat => 
                    chat.participants.length === 2 && 
                    chat.participants.some(p => p.id === friendId)
                );
                
                if (existingChat) {
                    this.selectChat(existingChat.id);
                } else {
                    await this.createChatWithUser(friendId);
                }
            }

            // –î—Ä—É–∑—å—è
            showAddFriendModal() {
                document.getElementById('addFriendModal').style.display = 'flex';
                document.getElementById('friendEmail').value = '';
                document.getElementById('friendSearchResults').innerHTML = '';
                document.getElementById('sendFriendRequestBtn').disabled = true;
            }

            hideAddFriendModal() {
                document.getElementById('addFriendModal').style.display = 'none';
            }

            async searchUsers(query) {
                if (!query || query.length < 3) {
                    document.getElementById('friendSearchResults').innerHTML = '';
                    document.getElementById('sendFriendRequestBtn').disabled = true;
                    return;
                }
                
                try {
                    const response = await fetch(`https://server-jbw1.onrender.com/api/users/search?query=${encodeURIComponent(query)}`, {
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });
                    
                    if (response.ok) {
                        const users = await response.json();
                        this.displayUserSearchResults(users, 'friend');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                }
            }

            displayUserSearchResults(users, type) {
                const container = type === 'friend' ? 
                    document.getElementById('friendSearchResults') : 
                    document.getElementById('userSearchResults');
                
                if (users.length === 0) {
                    container.innerHTML = '<div class="empty-state" style="padding: 20px; color: #666;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    
                    if (type === 'friend') {
                        document.getElementById('sendFriendRequestBtn').disabled = true;
                    } else {
                        document.getElementById('createNewChat').disabled = true;
                    }
                    
                    return;
                }
                
                container.innerHTML = users.map(user => {
                    const isFriend = user.isFriend;
                    const hasPendingRequest = user.hasPendingRequest;
                    
                    let buttonHtml = '';
                    if (type === 'friend') {
                        if (isFriend) {
                            buttonHtml = '<span style="color: #28a745;">‚úì –í –¥—Ä—É–∑—å—è—Ö</span>';
                        } else if (hasPendingRequest) {
                            buttonHtml = '<span style="color: #ffc107;">–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</span>';
                        } else {
                            buttonHtml = `<button class="modal-btn create" style="padding: 5px 15px; font-size: 14px;" data-user-id="${user.id}">–î–æ–±–∞–≤–∏—Ç—å</button>`;
                        }
                    } else {
                        buttonHtml = `<button class="modal-btn create" style="padding: 5px 15px; font-size: 14px;" data-user-id="${user.id}">–í—ã–±—Ä–∞—Ç—å</button>`;
                    }
                    
                    return `
                        <div class="search-result-item">
                            <div>
                                <div><strong>${user.name}</strong></div>
                                <div style="font-size: 12px; color: #666;">${user.email}</div>
                            </div>
                            <div>${buttonHtml}</div>
                        </div>
                    `;
                }).join('');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                container.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const userId = btn.getAttribute('data-user-id');
                        if (type === 'friend') {
                            this.sendFriendRequestToUser(userId);
                        } else {
                            this.createChatWithUser(userId);
                        }
                    });
                });
                
                if (type === 'friend') {
                    document.getElementById('sendFriendRequestBtn').disabled = false;
                } else {
                    document.getElementById('createNewChat').disabled = false;
                }
            }

            async sendFriendRequest() {
                const email = document.getElementById('friendEmail').value.trim();
                
                if (!email) {
                    this.showError('friendEmail', '–í–≤–µ–¥–∏—Ç–µ email –¥—Ä—É–≥–∞');
                    return;
                }
                
                if (!this.isValidEmail(email)) {
                    this.showError('friendEmail', '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email');
                    return;
                }
                
                this.showLoading('sendRequest', true);
                
                try {
                    const response = await fetch('https://server-jbw1.onrender.com/api/friends/request', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.authToken}`
                        },
                        body: JSON.stringify({ friendEmail: email })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.showNotification('–ó–∞–ø—Ä–æ—Å –Ω–∞ –¥—Ä—É–∂–±—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                        this.hideAddFriendModal();
                        this.loadFriendRequests();
                    } else {
                        this.showError('friendEmail', data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞');
                    }
                } catch (error) {
                    this.showError('friendEmail', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                } finally {
                    this.showLoading('sendRequest', false);
                }
            }

            async sendFriendRequestToUser(userId) {
                this.showLoading('sendRequest', true);
                
                try {
                    // –ü–æ–ª—É—á–∞–µ–º email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const user = await this.findUserById(userId);
                    if (!user) {
                        this.showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                        return;
                    }
                    
                    const response = await fetch('https://server-jbw1.onrender.com/api/friends/request', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.authToken}`
                        },
                        body: JSON.stringify({ friendEmail: user.email })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.showNotification(`–ó–∞–ø—Ä–æ—Å –Ω–∞ –¥—Ä—É–∂–±—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ${user.name}`, 'success');
                        this.hideAddFriendModal();
                        this.loadFriendRequests();
                    } else {
                        this.showNotification(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞', 'error');
                    }
                } catch (error) {
                    this.showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                } finally {
                    this.showLoading('sendRequest', false);
                }
            }

            async handleFriendRequest(requestId, action) {
                try {
                    const response = await fetch(`https://server-jbw1.onrender.com/api/friends/requests/${requestId}/${action}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });
                    
                    if (response.ok) {
                        if (action === 'accept') {
                            this.showNotification('–ó–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è –ø—Ä–∏–Ω—è—Ç', 'success');
                        } else {
                            this.showNotification('–ó–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è –æ—Ç–∫–ª–æ–Ω–µ–Ω', 'info');
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
                        this.loadFriends();
                        this.loadFriendRequests();
                    }
                } catch (error) {
                    this.showNotification('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞', 'error');
                }
            }

            // –ó–≤–æ–Ω–∫–∏
            startCall(type) {
                if (!this.currentChatId || !this.socket) {
                    this.showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –∑–≤–æ–Ω–∫–∞', 'warning');
                    return;
                }
                
                this.socket.emit('start_call', {
                    chatId: this.currentChatId,
                    type: type
                });
            }

            showIncomingCall(data) {
                this.currentCall = {
                    id: data.callId,
                    chatId: data.chatId,
                    caller: data.caller,
                    type: data.type,
                    status: 'incoming'
                };
                
                document.getElementById('callContainer').style.display = 'flex';
                document.getElementById('callPartnerName').textContent = data.caller;
                document.getElementById('callAvatar').textContent = data.caller.charAt(0);
                document.getElementById('callStatus').textContent = '–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...';
                document.getElementById('acceptCallBtn').style.display = 'block';
                document.getElementById('rejectCallBtn').style.display = 'block';
                document.getElementById('endCallBtn').style.display = 'none';
            }

            showCallInterface(status) {
                document.getElementById('callContainer').style.display = 'flex';
                document.getElementById('callStatus').textContent = status === 'calling' ? '–í—ã–∑–æ–≤...' : '–ó–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω';
                document.getElementById('acceptCallBtn').style.display = 'none';
                document.getElementById('rejectCallBtn').style.display = 'none';
                document.getElementById('endCallBtn').style.display = 'block';
            }

            acceptCall() {
                if (!this.currentCall || !this.socket) return;
                
                this.socket.emit('accept_call', {
                    callId: this.currentCall.id
                });
                
                this.showCallInterface('active');
                this.startCallTimer();
            }

            rejectCall() {
                if (this.currentCall && this.socket) {
                    this.socket.emit('end_call', {
                        callId: this.currentCall.id
                    });
                }
                this.endCall();
            }

            endCall() {
                if (this.currentCall && this.socket) {
                    this.socket.emit('end_call', {
                        callId: this.currentCall.id
                    });
                }
                
                this.currentCall = null;
                document.getElementById('callContainer').style.display = 'none';
                
                if (this.callTimerInterval) {
                    clearInterval(this.callTimerInterval);
                    this.callTimerInterval = null;
                }
            }

            startCallTimer() {
                this.callStartTime = new Date();
                
                this.callTimerInterval = setInterval(() => {
                    const now = new Date();
                    const diff = Math.floor((now - this.callStartTime) / 1000);
                    const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
                    const seconds = (diff % 60).toString().padStart(2, '0');
                    
                    document.getElementById('callTimer').textContent = `${minutes}:${seconds}`;
                }, 1000);
            }

            // –í—ã—Ö–æ–¥
            logout() {
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                    this.clearAuth();
                    location.reload();
                }
            }

            clearAuth() {
                localStorage.removeItem('beresta_token');
                localStorage.removeItem('beresta_user');
                localStorage.removeItem('beresta_chats');
                
                this.authToken = null;
                this.currentUser = null;
                this.isAuthenticated = false;
                this.chats = [];
                this.friends = [];
                this.friendRequests = [];
                
                this.updateUserUI();
                this.showAuthModal();
                
                if (this.socket) {
                    this.socket.disconnect();
                    this.socket = null;
                }
            }

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
            async findUserByEmail(email) {
                try {
                    const response = await fetch(`https://server-jbw1.onrender.com/api/users/search?query=${encodeURIComponent(email)}`, {
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });
                    
                    if (response.ok) {
                        const users = await response.json();
                        return users.find(u => u.email === email);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                }
                return null;
            }

            async findUserById(userId) {
                try {
                    const response = await fetch(`https://server-jbw1.onrender.com/api/users/search?query=`, {
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });
                    
                    if (response.ok) {
                        const users = await response.json();
                        return users.find(u => u.id === userId);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                }
                return null;
            }

            updateFriendStatus(friendId, status, lastSeen) {
                const friendIndex = this.friends.findIndex(f => f.id === friendId);
                if (friendIndex !== -1) {
                    this.friends[friendIndex].isOnline = status === 'online';
                    this.friends[friendIndex].lastSeen = lastSeen;
                    this.renderFriendsList();
                }
            }

            formatDuration(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }

            isValidEmail(email) {
                const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return regex.test(email);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showError(fieldId, message) {
                const errorElement = document.getElementById(`${fieldId}Error`);
                const inputElement = document.getElementById(fieldId);
                
                if (errorElement && inputElement) {
                    errorElement.textContent = message;
                    errorElement.style.display = 'block';
                    inputElement.classList.add('error');
                }
            }

            showLoading(context, show) {
                const loadingMap = {
                    'auth': { text: 'authSubmitText', loading: 'authLoading' },
                    'createChat': { text: 'createChatText', loading: 'createChatLoading' },
                    'sendRequest': { text: 'sendRequestText', loading: 'sendRequestLoading' }
                };
                
                const config = loadingMap[context];
                if (config) {
                    document.getElementById(config.text).style.display = show ? 'none' : 'inline';
                    document.getElementById(config.loading').style.display = show ? 'inline-block' : 'none';
                }
            }

            showNotification(message, type = 'info') {
                // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#007bff'};
                    color: white;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 3000;
                    animation: fadeIn 0.3s;
                    max-width: 400px;
                    word-wrap: break-word;
                `;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    notification.style.animation = 'fadeOut 0.3s';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 5000);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é fadeOut –≤ CSS
                if (!document.getElementById('notification-styles')) {
                    const style = document.createElement('style');
                    style.id = 'notification-styles';
                    style.textContent = `
                        @keyframes fadeOut {
                            from { opacity: 1; transform: translateY(0); }
                            to { opacity: 0; transform: translateY(-20px); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞
        document.addEventListener('DOMContentLoaded', () => {
            window.beresta = new BerezaMessenger();
        });
    </script>
</body>
</html>
